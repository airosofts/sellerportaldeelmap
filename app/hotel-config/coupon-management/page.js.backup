"use client";

import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { Plus, Edit2, Trash2, Search, X, Upload } from 'lucide-react';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { motion } from 'framer-motion';

// Main Coupon Management Component
const CouponManagement = () => {
  const [coupons, setCoupons] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [showAddModal, setShowAddModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [selectedCoupon, setSelectedCoupon] = useState(null);
  const [entriesPerPage, setEntriesPerPage] = useState(10);
  const [currentPage, setCurrentPage] = useState(1);

  useEffect(() => {
    fetchCoupons();
  }, []);

  const fetchCoupons = async () => {
    try {
      setLoading(true);
      const { data, error } = await supabase
        .from('coupons')
        .select('*')
        .order('id', { ascending: true });

      if (error) throw error;
      setCoupons(data || []);
    } catch (error) {
      console.error('Error fetching coupons:', error);
      alert('Failed to fetch coupons.');
    } finally {
      setLoading(false);
    }
  };

  // Filter based on search
  const filteredData = coupons.filter(coupon =>
    coupon.offer_title?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  // Pagination
  const indexOfLastEntry = currentPage * entriesPerPage;
  const indexOfFirstEntry = indexOfLastEntry - entriesPerPage;
  const currentEntries = filteredData.slice(indexOfFirstEntry, indexOfLastEntry);
  const totalPages = Math.ceil(filteredData.length / entriesPerPage);

  const handleDelete = async (id) => {
    if (window.confirm('Are you sure you want to delete this coupon?')) {
      try {
        const { error } = await supabase
          .from('coupons')
          .delete()
          .eq('id', id);

        if (error) throw error;
        fetchCoupons();
        alert('Coupon deleted successfully!');
      } catch (error) {
        console.error('Error deleting coupon:', error);
        alert('Failed to delete coupon.');
      }
    }
  };

  return (
    <DashboardLayout>
      <div className="min-h-screen bg-gray-50">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="mb-8"
        >
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">Coupon Management</h1>
              <p className="text-gray-600">Manage discount coupons</p>
            </div>
            <button
              onClick={() => setShowAddModal(true)}
              className="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
            >
              <Plus size={20} />
              Add
            </button>
          </div>
        </motion.div>

        {/* Main Content */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1, duration: 0.5 }}
          className="bg-white rounded-2xl shadow-md border border-gray-100 hover:shadow-xl transition-shadow duration-300"
        >
          {/* Controls */}
          <div className="p-6 border-b border-gray-200">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-3">
                <span className="text-sm font-medium text-gray-700">Show</span>
                <select
                  value={entriesPerPage}
                  onChange={(e) => {
                    setEntriesPerPage(Number(e.target.value));
                    setCurrentPage(1);
                  }}
                  className="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value={10}>10</option>
                  <option value={25}>25</option>
                  <option value={50}>50</option>
                  <option value={100}>100</option>
                </select>
                <span className="text-sm font-medium text-gray-700">entries</span>
              </div>

              <div className="flex items-center gap-3">
                <span className="text-sm font-medium text-gray-700">Search:</span>
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
                  <input
                    type="text"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="border border-gray-300 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Search..."
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Table */}
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">#</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Title</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                  <th className="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Action</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {loading ? (
                  <tr>
                    <td colSpan="4" className="px-6 py-8 text-center text-gray-500">
                      <div className="flex items-center justify-center">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                      </div>
                    </td>
                  </tr>
                ) : currentEntries.length === 0 ? (
                  <tr>
                    <td colSpan="4" className="px-6 py-8 text-center text-gray-500">
                      No coupons found
                    </td>
                  </tr>
                ) : (
                  currentEntries.map((coupon, index) => (
                    <tr key={coupon.id} className="hover:bg-gray-50 transition-colors duration-200">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {indexOfFirstEntry + index + 1}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {coupon.offer_title}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm">
                        <span className="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                          Active
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div className="flex items-center justify-end gap-2">
                          <button
                            onClick={() => {
                              setSelectedCoupon(coupon);
                              setShowEditModal(true);
                            }}
                            className="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-3 py-2 rounded-lg transition-all flex items-center gap-1.5 font-medium shadow-sm hover:shadow-md text-xs"
                          >
                            <Edit2 size={14} />
                            Edit
                          </button>
                          <button
                            onClick={() => handleDelete(coupon.id)}
                            className="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-3 py-2 rounded-lg transition-all flex items-center gap-1.5 font-medium shadow-sm hover:shadow-md text-xs"
                          >
                            <Trash2 size={14} />
                            Delete
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>

          {/* Pagination */}
          <div className="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
            <div className="text-sm text-gray-600 font-medium">
              Showing {indexOfFirstEntry + 1} to {Math.min(indexOfLastEntry, filteredData.length)} of {filteredData.length} entries
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                disabled={currentPage === 1}
                className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Previous
              </button>
              {[...Array(totalPages)].map((_, i) => (
                <button
                  key={i + 1}
                  onClick={() => setCurrentPage(i + 1)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                    currentPage === i + 1
                      ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md'
                      : 'border border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  {i + 1}
                </button>
              ))}
              <button
                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                disabled={currentPage === totalPages}
                className="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Next
              </button>
            </div>
          </div>
        </motion.div>

        {/* Modals */}
        {showAddModal && (
          <AddCouponModal
            onClose={() => setShowAddModal(false)}
            onSuccess={fetchCoupons}
          />
        )}
        {showEditModal && selectedCoupon && (
          <EditCouponModal
            coupon={selectedCoupon}
            onClose={() => {
              setShowEditModal(false);
              setSelectedCoupon(null);
            }}
            onSuccess={fetchCoupons}
          />
        )}
      </div>
    </DashboardLayout>
  );
};

// Add Coupon Modal
const AddCouponModal = ({ onClose, onSuccess }) => {
  const [users, setUsers] = useState([]);
  const [roomTypes, setRoomTypes] = useState([]);
  const [paidServices, setPaidServices] = useState([]);

  const [availableIncludeUsers, setAvailableIncludeUsers] = useState([]);
  const [selectedIncludeUsers, setSelectedIncludeUsers] = useState([]);
  const [availableExcludeUsers, setAvailableExcludeUsers] = useState([]);
  const [selectedExcludeUsers, setSelectedExcludeUsers] = useState([]);

  const [availableIncludeRoomTypes, setAvailableIncludeRoomTypes] = useState([]);
  const [selectedIncludeRoomTypes, setSelectedIncludeRoomTypes] = useState([]);
  const [availableExcludeRoomTypes, setAvailableExcludeRoomTypes] = useState([]);
  const [selectedExcludeRoomTypes, setSelectedExcludeRoomTypes] = useState([]);

  const [searchIncludeUser, setSearchIncludeUser] = useState('');
  const [searchExcludeUser, setSearchExcludeUser] = useState('');
  const [searchIncludeRoomType, setSearchIncludeRoomType] = useState('');
  const [searchExcludeRoomType, setSearchExcludeRoomType] = useState('');

  const [formData, setFormData] = useState({
    offer_title: '',
    description: '',
    offer_image: '',
    coupon_period_start: '',
    coupon_period_end: '',
    coupon_code: '',
    coupon_type: '',
    coupon_value: '',
    min_amount: '',
    max_amount: '',
    limit_per_user: '',
    limit_per_coupon: '',
    paid_services: []
  });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    try {
      // Fetch users
      const { data: usersData } = await supabase
        .from('users')
        .select('id, full_name, email')
        .order('full_name', { ascending: true });

      setUsers(usersData || []);
      setAvailableIncludeUsers(usersData || []);
      setAvailableExcludeUsers(usersData || []);

      // Fetch room types
      const { data: roomTypesData } = await supabase
        .from('room_types')
        .select('id, title')
        .order('title', { ascending: true });

      setRoomTypes(roomTypesData || []);
      setAvailableIncludeRoomTypes(roomTypesData || []);
      setAvailableExcludeRoomTypes(roomTypesData || []);

      // Fetch paid services
      const { data: servicesData } = await supabase
        .from('paid_services')
        .select('id, title')
        .eq('status', true)
        .order('title', { ascending: true });

      setPaidServices(servicesData || []);
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, offer_image: reader.result }));
      };
      reader.readAsDataURL(file);
    }
  };

  // User movement functions
  const moveUserToInclude = (user) => {
    setSelectedIncludeUsers([...selectedIncludeUsers, user]);
    setAvailableIncludeUsers(availableIncludeUsers.filter(u => u.id !== user.id));
  };

  const removeUserFromInclude = (user) => {
    setAvailableIncludeUsers([...availableIncludeUsers, user]);
    setSelectedIncludeUsers(selectedIncludeUsers.filter(u => u.id !== user.id));
  };

  const moveUserToExclude = (user) => {
    setSelectedExcludeUsers([...selectedExcludeUsers, user]);
    setAvailableExcludeUsers(availableExcludeUsers.filter(u => u.id !== user.id));
  };

  const removeUserFromExclude = (user) => {
    setAvailableExcludeUsers([...availableExcludeUsers, user]);
    setSelectedExcludeUsers(selectedExcludeUsers.filter(u => u.id !== user.id));
  };

  // Room type movement functions
  const moveRoomTypeToInclude = (roomType) => {
    setSelectedIncludeRoomTypes([...selectedIncludeRoomTypes, roomType]);
    setAvailableIncludeRoomTypes(availableIncludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const removeRoomTypeFromInclude = (roomType) => {
    setAvailableIncludeRoomTypes([...availableIncludeRoomTypes, roomType]);
    setSelectedIncludeRoomTypes(selectedIncludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const moveRoomTypeToExclude = (roomType) => {
    setSelectedExcludeRoomTypes([...selectedExcludeRoomTypes, roomType]);
    setAvailableExcludeRoomTypes(availableExcludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const removeRoomTypeFromExclude = (roomType) => {
    setAvailableExcludeRoomTypes([...availableExcludeRoomTypes, roomType]);
    setSelectedExcludeRoomTypes(selectedExcludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!formData.offer_title || !formData.coupon_code) {
      alert('Please fill in required fields');
      return;
    }

    try {
      setSaving(true);

      // Format coupon period for PostgreSQL DATERANGE
      const couponPeriod = formData.coupon_period_start && formData.coupon_period_end
        ? `[${formData.coupon_period_start},${formData.coupon_period_end}]`
        : null;

      const { error } = await supabase
        .from('coupons')
        .insert([{
          offer_title: formData.offer_title,
          description: formData.description,
          offer_image: formData.offer_image,
          coupon_period: couponPeriod,
          coupon_code: formData.coupon_code,
          coupon_type: formData.coupon_type || null,
          coupon_value: parseFloat(formData.coupon_value) || 0,
          min_amount: parseFloat(formData.min_amount) || 0,
          max_amount: parseFloat(formData.max_amount) || 0,
          include_user: selectedIncludeUsers.map(u => u.id),
          exclude_user: selectedExcludeUsers.map(u => u.id),
          include_room_type: selectedIncludeRoomTypes.map(rt => rt.id),
          exclude_room_type: selectedExcludeRoomTypes.map(rt => rt.id),
          limit_per_user: parseInt(formData.limit_per_user) || 0,
          limit_per_coupon: parseInt(formData.limit_per_coupon) || 0,
          paid_services: formData.paid_services
        }]);

      if (error) throw error;

      alert('Coupon added successfully!');
      onSuccess();
      onClose();
    } catch (error) {
      console.error('Error adding coupon:', error);
      alert('Failed to add coupon: ' + error.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl my-8 max-h-[calc(100vh-4rem)] flex flex-col">
        <div className="flex items-center justify-between px-6 py-5 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-gray-900">Coupon Form</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto">
          <div className="p-6 space-y-6">
            {/* Offer Title */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Offer Title <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={formData.offer_title}
                onChange={(e) => setFormData(prev => ({ ...prev, offer_title: e.target.value }))}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                placeholder="Enter offer title"
                required
              />
            </div>

            {/* Description */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                rows={4}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
                placeholder="Enter description"
              />
            </div>

            {/* Offer Image */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Offer Image</label>
              <div className="flex items-center gap-4">
                <label className="flex items-center gap-2 px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                  <Upload size={18} />
                  <span className="text-sm">Choose File</span>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="hidden"
                  />
                </label>
                {formData.offer_image && (
                  <img src={formData.offer_image} alt="Preview" className="h-16 w-16 object-cover rounded-lg border border-gray-300" />
                )}
              </div>
            </div>

            {/* Coupon Period */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Period</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  type="datetime-local"
                  value={formData.coupon_period_start}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_period_start: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
                <input
                  type="datetime-local"
                  value={formData.coupon_period_end}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_period_end: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
              </div>
            </div>

            {/* Coupon Code, Type, Value */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Coupon Code <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.coupon_code}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_code: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="SAVE20"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Type</label>
                <select
                  value={formData.coupon_type}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_type: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                >
                  <option value="">Select Type</option>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Value</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.coupon_value}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_value: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>
            </div>

            {/* Min/Max Amount */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Minimum Amount</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.min_amount}
                  onChange={(e) => setFormData(prev => ({ ...prev, min_amount: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Maximum Amount</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.max_amount}
                  onChange={(e) => setFormData(prev => ({ ...prev, max_amount: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>
            </div>

            {/* Include User */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Include User</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchIncludeUser}
                    onChange={(e) => setSearchIncludeUser(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableIncludeUsers.filter(u =>
                      u.full_name?.toLowerCase().includes(searchIncludeUser.toLowerCase())
                    ).map(user => (
                      <div
                        key={user.id}
                        onClick={() => moveUserToInclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name} ({user.email})
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Selected Users
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedIncludeUsers.map(user => (
                      <div
                        key={user.id}
                        onClick={() => removeUserFromInclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Exclude User */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Exclude User</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchExcludeUser}
                    onChange={(e) => setSearchExcludeUser(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableExcludeUsers.filter(u =>
                      u.full_name?.toLowerCase().includes(searchExcludeUser.toLowerCase())
                    ).map(user => (
                      <div
                        key={user.id}
                        onClick={() => moveUserToExclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name} ({user.email})
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Excluded Users
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedExcludeUsers.map(user => (
                      <div
                        key={user.id}
                        onClick={() => removeUserFromExclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Include Room Type */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Include Room Type</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchIncludeRoomType}
                    onChange={(e) => setSearchIncludeRoomType(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableIncludeRoomTypes.filter(rt =>
                      rt.title?.toLowerCase().includes(searchIncludeRoomType.toLowerCase())
                    ).map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => moveRoomTypeToInclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Selected Room Types
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedIncludeRoomTypes.map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => removeRoomTypeFromInclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Exclude Room Type */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Exclude Room Type</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchExcludeRoomType}
                    onChange={(e) => setSearchExcludeRoomType(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableExcludeRoomTypes.filter(rt =>
                      rt.title?.toLowerCase().includes(searchExcludeRoomType.toLowerCase())
                    ).map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => moveRoomTypeToExclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Excluded Room Types
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedExcludeRoomTypes.map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => removeRoomTypeFromExclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Limits */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Limit Per User</label>
                <input
                  type="number"
                  value={formData.limit_per_user}
                  onChange={(e) => setFormData(prev => ({ ...prev, limit_per_user: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Limit Per Coupon</label>
                <input
                  type="number"
                  value={formData.limit_per_coupon}
                  onChange={(e) => setFormData(prev => ({ ...prev, limit_per_coupon: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                />
              </div>
            </div>

            {/* Paid Services */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Paid Services</label>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {paidServices.map(service => (
                  <label key={service.id} className="flex items-center gap-2 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <input
                      type="checkbox"
                      checked={formData.paid_services.includes(service.id)}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setFormData(prev => ({
                            ...prev,
                            paid_services: [...prev.paid_services, service.id]
                          }));
                        } else {
                          setFormData(prev => ({
                            ...prev,
                            paid_services: prev.paid_services.filter(id => id !== service.id)
                          }));
                        }
                      }}
                      className="w-4 h-4 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">{service.title}</span>
                  </label>
                ))}
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
              <button
                type="button"
                onClick={onClose}
                className="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 font-semibold hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={saving}
                className="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-semibold transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {saving ? 'Saving...' : 'Save'}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  );
};

// Edit Coupon Modal
const EditCouponModal = ({ coupon, onClose, onSuccess }) => {
  const [users, setUsers] = useState([]);
  const [roomTypes, setRoomTypes] = useState([]);
  const [paidServices, setPaidServices] = useState([]);

  const [availableIncludeUsers, setAvailableIncludeUsers] = useState([]);
  const [selectedIncludeUsers, setSelectedIncludeUsers] = useState([]);
  const [availableExcludeUsers, setAvailableExcludeUsers] = useState([]);
  const [selectedExcludeUsers, setSelectedExcludeUsers] = useState([]);

  const [availableIncludeRoomTypes, setAvailableIncludeRoomTypes] = useState([]);
  const [selectedIncludeRoomTypes, setSelectedIncludeRoomTypes] = useState([]);
  const [availableExcludeRoomTypes, setAvailableExcludeRoomTypes] = useState([]);
  const [selectedExcludeRoomTypes, setSelectedExcludeRoomTypes] = useState([]);

  const [searchIncludeUser, setSearchIncludeUser] = useState('');
  const [searchExcludeUser, setSearchExcludeUser] = useState('');
  const [searchIncludeRoomType, setSearchIncludeRoomType] = useState('');
  const [searchExcludeRoomType, setSearchExcludeRoomType] = useState('');

  // Parse coupon period from PostgreSQL DATERANGE format
  const parseCouponPeriod = (dateRange) => {
    if (!dateRange) return { start: '', end: '' };
    // Format: [2018-02-28 00:00:00,2018-02-28 23:59:00]
    const matches = dateRange.match(/\[(.+?),(.+?)\]/);
    if (matches) {
      return {
        start: matches[1].trim().replace(' ', 'T'),
        end: matches[2].trim().replace(' ', 'T')
      };
    }
    return { start: '', end: '' };
  };

  const couponPeriod = parseCouponPeriod(coupon.coupon_period);

  const [formData, setFormData] = useState({
    offer_title: coupon.offer_title || '',
    description: coupon.description || '',
    offer_image: coupon.offer_image || '',
    coupon_period_start: couponPeriod.start,
    coupon_period_end: couponPeriod.end,
    coupon_code: coupon.coupon_code || '',
    coupon_type: coupon.coupon_type || '',
    coupon_value: coupon.coupon_value || '',
    min_amount: coupon.min_amount || '',
    max_amount: coupon.max_amount || '',
    limit_per_user: coupon.limit_per_user || '',
    limit_per_coupon: coupon.limit_per_coupon || '',
    paid_services: coupon.paid_services || []
  });
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    try {
      // Fetch users
      const { data: usersData } = await supabase
        .from('users')
        .select('id, full_name, email')
        .order('full_name', { ascending: true });

      const allUsers = usersData || [];
      setUsers(allUsers);

      // Split users into included and excluded
      const includedUserIds = coupon.include_user || [];
      const excludedUserIds = coupon.exclude_user || [];

      const includedUsers = allUsers.filter(u => includedUserIds.includes(u.id));
      const excludedUsers = allUsers.filter(u => excludedUserIds.includes(u.id));
      const availableUsers = allUsers.filter(u => !includedUserIds.includes(u.id) && !excludedUserIds.includes(u.id));

      setSelectedIncludeUsers(includedUsers);
      setSelectedExcludeUsers(excludedUsers);
      setAvailableIncludeUsers([...availableUsers, ...excludedUsers]);
      setAvailableExcludeUsers([...availableUsers, ...includedUsers]);

      // Fetch room types
      const { data: roomTypesData } = await supabase
        .from('room_types')
        .select('id, title')
        .order('title', { ascending: true });

      const allRoomTypes = roomTypesData || [];
      setRoomTypes(allRoomTypes);

      // Split room types into included and excluded
      const includedRoomTypeIds = coupon.include_room_type || [];
      const excludedRoomTypeIds = coupon.exclude_room_type || [];

      const includedRoomTypes = allRoomTypes.filter(rt => includedRoomTypeIds.includes(rt.id));
      const excludedRoomTypes = allRoomTypes.filter(rt => excludedRoomTypeIds.includes(rt.id));
      const availableRTs = allRoomTypes.filter(rt => !includedRoomTypeIds.includes(rt.id) && !excludedRoomTypeIds.includes(rt.id));

      setSelectedIncludeRoomTypes(includedRoomTypes);
      setSelectedExcludeRoomTypes(excludedRoomTypes);
      setAvailableIncludeRoomTypes([...availableRTs, ...excludedRoomTypes]);
      setAvailableExcludeRoomTypes([...availableRTs, ...includedRoomTypes]);

      // Fetch paid services
      const { data: servicesData } = await supabase
        .from('paid_services')
        .select('id, title')
        .eq('status', true)
        .order('title', { ascending: true });

      setPaidServices(servicesData || []);
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setFormData(prev => ({ ...prev, offer_image: reader.result }));
      };
      reader.readAsDataURL(file);
    }
  };

  // User movement functions
  const moveUserToInclude = (user) => {
    setSelectedIncludeUsers([...selectedIncludeUsers, user]);
    setAvailableIncludeUsers(availableIncludeUsers.filter(u => u.id !== user.id));
  };

  const removeUserFromInclude = (user) => {
    setAvailableIncludeUsers([...availableIncludeUsers, user]);
    setSelectedIncludeUsers(selectedIncludeUsers.filter(u => u.id !== user.id));
  };

  const moveUserToExclude = (user) => {
    setSelectedExcludeUsers([...selectedExcludeUsers, user]);
    setAvailableExcludeUsers(availableExcludeUsers.filter(u => u.id !== user.id));
  };

  const removeUserFromExclude = (user) => {
    setAvailableExcludeUsers([...availableExcludeUsers, user]);
    setSelectedExcludeUsers(selectedExcludeUsers.filter(u => u.id !== user.id));
  };

  // Room type movement functions
  const moveRoomTypeToInclude = (roomType) => {
    setSelectedIncludeRoomTypes([...selectedIncludeRoomTypes, roomType]);
    setAvailableIncludeRoomTypes(availableIncludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const removeRoomTypeFromInclude = (roomType) => {
    setAvailableIncludeRoomTypes([...availableIncludeRoomTypes, roomType]);
    setSelectedIncludeRoomTypes(selectedIncludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const moveRoomTypeToExclude = (roomType) => {
    setSelectedExcludeRoomTypes([...selectedExcludeRoomTypes, roomType]);
    setAvailableExcludeRoomTypes(availableExcludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const removeRoomTypeFromExclude = (roomType) => {
    setAvailableExcludeRoomTypes([...availableExcludeRoomTypes, roomType]);
    setSelectedExcludeRoomTypes(selectedExcludeRoomTypes.filter(rt => rt.id !== roomType.id));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!formData.offer_title || !formData.coupon_code) {
      alert('Please fill in required fields');
      return;
    }

    try {
      setSaving(true);

      // Format coupon period for PostgreSQL DATERANGE
      const couponPeriod = formData.coupon_period_start && formData.coupon_period_end
        ? `[${formData.coupon_period_start},${formData.coupon_period_end}]`
        : null;

      const { error } = await supabase
        .from('coupons')
        .update({
          offer_title: formData.offer_title,
          description: formData.description,
          offer_image: formData.offer_image,
          coupon_period: couponPeriod,
          coupon_code: formData.coupon_code,
          coupon_type: formData.coupon_type || null,
          coupon_value: parseFloat(formData.coupon_value) || 0,
          min_amount: parseFloat(formData.min_amount) || 0,
          max_amount: parseFloat(formData.max_amount) || 0,
          include_user: selectedIncludeUsers.map(u => u.id),
          exclude_user: selectedExcludeUsers.map(u => u.id),
          include_room_type: selectedIncludeRoomTypes.map(rt => rt.id),
          exclude_room_type: selectedExcludeRoomTypes.map(rt => rt.id),
          limit_per_user: parseInt(formData.limit_per_user) || 0,
          limit_per_coupon: parseInt(formData.limit_per_coupon) || 0,
          paid_services: formData.paid_services
        })
        .eq('id', coupon.id);

      if (error) throw error;

      alert('Coupon updated successfully!');
      onSuccess();
      onClose();
    } catch (error) {
      console.error('Error updating coupon:', error);
      alert('Failed to update coupon: ' + error.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl my-8 max-h-[calc(100vh-4rem)] flex flex-col">
        <div className="flex items-center justify-between px-6 py-5 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-gray-900">Edit Coupon</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <X size={24} />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto">
          <div className="p-6 space-y-6">
            {/* Offer Title */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Offer Title <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={formData.offer_title}
                onChange={(e) => setFormData(prev => ({ ...prev, offer_title: e.target.value }))}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                placeholder="Enter offer title"
                required
              />
            </div>

            {/* Description */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                rows={4}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none"
                placeholder="Enter description"
              />
            </div>

            {/* Offer Image */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Offer Image</label>
              <div className="flex items-center gap-4">
                <label className="flex items-center gap-2 px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                  <Upload size={18} />
                  <span className="text-sm">Choose File</span>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="hidden"
                  />
                </label>
                {formData.offer_image && (
                  <img src={formData.offer_image} alt="Preview" className="h-16 w-16 object-cover rounded-lg border border-gray-300" />
                )}
              </div>
            </div>

            {/* Coupon Period */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Period</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  type="datetime-local"
                  value={formData.coupon_period_start}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_period_start: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
                <input
                  type="datetime-local"
                  value={formData.coupon_period_end}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_period_end: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                />
              </div>
            </div>

            {/* Coupon Code, Type, Value */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Coupon Code <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.coupon_code}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_code: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="SAVE20"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Type</label>
                <select
                  value={formData.coupon_type}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_type: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                >
                  <option value="">Select Type</option>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Coupon Value</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.coupon_value}
                  onChange={(e) => setFormData(prev => ({ ...prev, coupon_value: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>
            </div>

            {/* Min/Max Amount */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Minimum Amount</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.min_amount}
                  onChange={(e) => setFormData(prev => ({ ...prev, min_amount: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Maximum Amount</label>
                <input
                  type="number"
                  step="0.01"
                  value={formData.max_amount}
                  onChange={(e) => setFormData(prev => ({ ...prev, max_amount: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0.00"
                />
              </div>
            </div>

            {/* Include User */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Include User</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchIncludeUser}
                    onChange={(e) => setSearchIncludeUser(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableIncludeUsers.filter(u =>
                      u.full_name?.toLowerCase().includes(searchIncludeUser.toLowerCase())
                    ).map(user => (
                      <div
                        key={user.id}
                        onClick={() => moveUserToInclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name} ({user.email})
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Selected Users
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedIncludeUsers.map(user => (
                      <div
                        key={user.id}
                        onClick={() => removeUserFromInclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Exclude User */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Exclude User</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchExcludeUser}
                    onChange={(e) => setSearchExcludeUser(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableExcludeUsers.filter(u =>
                      u.full_name?.toLowerCase().includes(searchExcludeUser.toLowerCase())
                    ).map(user => (
                      <div
                        key={user.id}
                        onClick={() => moveUserToExclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name} ({user.email})
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Excluded Users
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedExcludeUsers.map(user => (
                      <div
                        key={user.id}
                        onClick={() => removeUserFromExclude(user)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {user.full_name}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Include Room Type */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Include Room Type</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchIncludeRoomType}
                    onChange={(e) => setSearchIncludeRoomType(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableIncludeRoomTypes.filter(rt =>
                      rt.title?.toLowerCase().includes(searchIncludeRoomType.toLowerCase())
                    ).map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => moveRoomTypeToInclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Selected Room Types
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedIncludeRoomTypes.map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => removeRoomTypeFromInclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Exclude Room Type */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Exclude Room Type</label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <input
                    type="text"
                    placeholder="Search.."
                    value={searchExcludeRoomType}
                    onChange={(e) => setSearchExcludeRoomType(e.target.value)}
                    className="w-full px-4 py-2 border-b border-gray-300 focus:outline-none"
                  />
                  <div className="h-48 overflow-y-auto bg-white">
                    {availableExcludeRoomTypes.filter(rt =>
                      rt.title?.toLowerCase().includes(searchExcludeRoomType.toLowerCase())
                    ).map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => moveRoomTypeToExclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="border border-gray-300 rounded-xl overflow-hidden">
                  <div className="px-4 py-2 border-b border-gray-300 bg-gray-50 text-sm font-semibold">
                    Excluded Room Types
                  </div>
                  <div className="h-48 overflow-y-auto bg-white">
                    {selectedExcludeRoomTypes.map(roomType => (
                      <div
                        key={roomType.id}
                        onClick={() => removeRoomTypeFromExclude(roomType)}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer transition-colors text-sm"
                      >
                        {roomType.title}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Limits */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Limit Per User</label>
                <input
                  type="number"
                  value={formData.limit_per_user}
                  onChange={(e) => setFormData(prev => ({ ...prev, limit_per_user: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Limit Per Coupon</label>
                <input
                  type="number"
                  value={formData.limit_per_coupon}
                  onChange={(e) => setFormData(prev => ({ ...prev, limit_per_coupon: e.target.value }))}
                  className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="0"
                />
              </div>
            </div>

            {/* Paid Services */}
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Paid Services</label>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                {paidServices.map(service => (
                  <label key={service.id} className="flex items-center gap-2 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <input
                      type="checkbox"
                      checked={formData.paid_services.includes(service.id)}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setFormData(prev => ({
                            ...prev,
                            paid_services: [...prev.paid_services, service.id]
                          }));
                        } else {
                          setFormData(prev => ({
                            ...prev,
                            paid_services: prev.paid_services.filter(id => id !== service.id)
                          }));
                        }
                      }}
                      className="w-4 h-4 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">{service.title}</span>
                  </label>
                ))}
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex items-center justify-end gap-3 pt-6 border-t border-gray-200">
              <button
                type="button"
                onClick={onClose}
                className="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 font-semibold hover:bg-gray-50 transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                disabled={saving}
                className="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl font-semibold transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {saving ? 'Updating...' : 'Update'}
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  );
};

export default CouponManagement;